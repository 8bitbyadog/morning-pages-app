(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))a(l);new MutationObserver(l=>{for(const c of l)if(c.type==="childList")for(const u of c.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&a(u)}).observe(document,{childList:!0,subtree:!0});function r(l){const c={};return l.integrity&&(c.integrity=l.integrity),l.referrerPolicy&&(c.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?c.credentials="include":l.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function a(l){if(l.ep)return;l.ep=!0;const c=r(l);fetch(l.href,c)}})();class be{constructor(){this.dbName="morning-pages-db",this.dbVersion=1,this.db=null,this.storeName="writings",this.initialized=!1,this.initPromise=this.initDatabase()}async initDatabase(){return new Promise((s,r)=>{if(!window.indexedDB){console.log("Your browser doesn't support IndexedDB. Falling back to localStorage."),this.initialized=!1,r(new Error("IndexedDB not supported"));return}const a=indexedDB.open(this.dbName,this.dbVersion);a.onerror=l=>{console.error("Database error:",l.target.error),this.initialized=!1,r(l.target.error)},a.onsuccess=l=>{this.db=l.target.result,this.initialized=!0,console.log("Database initialized successfully"),s()},a.onupgradeneeded=l=>{const c=l.target.result;if(console.log("Database upgrade needed"),!c.objectStoreNames.contains("writings")){console.log("Creating writings store");const u=c.createObjectStore("writings",{keyPath:"id",autoIncrement:!0});u.createIndex("date","date",{unique:!1}),u.createIndex("userId","userId",{unique:!1})}if(!c.objectStoreNames.contains("users")){console.log("Creating users store");const u=c.createObjectStore("users",{keyPath:"email"});u.createIndex("createdAt","createdAt",{unique:!1}),u.createIndex("lastLogin","lastLogin",{unique:!1})}console.log("Database setup complete")}})}async ensureInitialized(){this.initialized||(console.log("Database not initialized, waiting for initialization..."),await this.initPromise,console.log("Database initialization complete"))}async saveWriting(s,r={}){try{await this.ensureInitialized();const a=new Date,l=a.toISOString().split("T")[0],c={text:s,date:l,dateTime:a.toISOString(),wordCount:this.countWords(s),complete:r.complete||!1,emotions:r.emotions||null,topics:r.topics||null,...r},u=await this.getTodayWriting();return new Promise((m,d)=>{const L=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName);let I;u?(c.id=u.id,I=L.put(c)):I=L.add(c),I.onsuccess=()=>{console.log("Writing saved successfully"),this.saveToLocalStorage(s),m()},I.onerror=P=>{console.error("Error saving writing:",P.target.error),this.saveToLocalStorage(s),d(P.target.error)}})}catch(a){throw console.error("Failed to save writing:",a),this.saveToLocalStorage(s),a}}saveToLocalStorage(s){try{localStorage.setItem("savedText",s),localStorage.setItem("lastSaved",new Date().toISOString())}catch(r){if(console.error("LocalStorage save failed:",r),r.name==="QuotaExceededError"){const a=s.substring(0,1e6);try{localStorage.setItem("savedText",a),localStorage.setItem("lastSaved",new Date().toISOString()),localStorage.setItem("truncated","true")}catch{console.error("Even truncated save failed")}}}}async getTodayWriting(){try{await this.ensureInitialized();const s=new Date().toISOString().split("T")[0];return new Promise((r,a)=>{const m=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).index("date").get(s);m.onsuccess=()=>{console.log("Today's writing retrieved successfully"),r(m.result)},m.onerror=d=>{console.error("Error getting today's writing:",d.target.error);const f=localStorage.getItem("savedText");r(f?{text:f,date:s,dateTime:localStorage.getItem("lastSaved")}:null)}})}catch(s){console.error("Failed to get today's writing:",s);const r=localStorage.getItem("savedText");return r?{text:r,date:new Date().toISOString().split("T")[0],dateTime:localStorage.getItem("lastSaved")}:null}}async getAllWritings(){try{return await this.ensureInitialized(),new Promise((s,r)=>{const c=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();c.onsuccess=()=>{s(c.result)},c.onerror=u=>{console.error("Error getting all writings:",u.target.error),r(u.target.error)}})}catch(s){return console.error("Failed to get all writings:",s),[]}}async getWritingsByDateRange(s,r){try{return await this.ensureInitialized(),new Promise((a,l)=>{const d=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).index("date").getAll(IDBKeyRange.bound(s,r));d.onsuccess=()=>{a(d.result)},d.onerror=f=>{console.error("Error getting writings by date range:",f.target.error),l(f.target.error)}})}catch(a){return console.error("Failed to get writings by date range:",a),[]}}countWords(s){const r=s.trim().match(/\S+/g);return r?r.length:0}async deleteWriting(s){try{return await this.ensureInitialized(),new Promise((r,a)=>{const u=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(s);u.onsuccess=()=>{r()},u.onerror=m=>{console.error("Error deleting writing:",m.target.error),a(m.target.error)}})}catch(r){throw console.error("Failed to delete writing:",r),r}}async createUser(s,r){try{await this.ensureInitialized();const a=await this.hashPassword(r),l={email:s,password:a,createdAt:new Date().toISOString(),lastLogin:new Date().toISOString()};return new Promise((c,u)=>{const f=this.db.transaction(["users"],"readwrite").objectStore("users").add(l);f.onsuccess=()=>{console.log("User created successfully"),c()},f.onerror=L=>{console.error("Error creating user:",L.target.error),u(L.target.error)}})}catch(a){throw console.error("Failed to create user:",a),a}}async getUser(s){try{return await this.ensureInitialized(),new Promise((r,a)=>{const u=this.db.transaction(["users"],"readonly").objectStore("users").get(s);u.onsuccess=()=>{r(u.result)},u.onerror=m=>{console.error("Error getting user:",m.target.error),a(m.target.error)}})}catch(r){throw console.error("Failed to get user:",r),r}}async getAllUsers(){return new Promise((s,r)=>{const c=this.db.transaction(["users"],"readonly").objectStore("users").getAll();c.onsuccess=()=>s(c.result),c.onerror=()=>r(c.error)})}async updateUserLastLogin(s){try{return await this.ensureInitialized(),new Promise((r,a)=>{const c=this.db.transaction(["users"],"readwrite").objectStore("users"),u=c.get(s);u.onsuccess=()=>{const m=u.result;if(m){m.lastLogin=new Date().toISOString();const d=c.put(m);d.onsuccess=()=>{console.log("Last login updated successfully"),r()},d.onerror=f=>{console.error("Error updating last login:",f.target.error),a(f.target.error)}}else a(new Error("User not found"))},u.onerror=m=>{console.error("Error getting user for last login update:",m.target.error),a(m.target.error)}})}catch(r){throw console.error("Failed to update last login:",r),r}}async hashPassword(s){const a=new TextEncoder().encode(s),l=await crypto.subtle.digest("SHA-256",a);return Array.from(new Uint8Array(l)).map(c=>c.toString(16).padStart(2,"0")).join("")}}class Se{constructor(s){this.formActionUrl=s,this.entryIdField="entry.123456789",this.enabled=!1,console.log("GoogleFormSubmitter instance created")}init(s,r){return console.log("Initializing GoogleFormSubmitter with:",{formActionUrl:s,entryIdField:r}),s&&(this.formActionUrl=s),r&&(this.entryIdField=r),this.enabled=!!(this.formActionUrl&&this.entryIdField),console.log("GoogleFormSubmitter initialization complete:",{enabled:this.enabled,formUrl:this.formActionUrl,entryId:this.entryIdField}),this.enabled}async submitEmail(s){if(console.log("submitEmail called with:",s),!this.enabled||!s)return console.warn("Form submission skipped:",{enabled:this.enabled,emailProvided:!!s}),!1;try{console.log("Creating form data for submission...");const r=new FormData;r.append(this.entryIdField,s),console.log("Attempting form submission with:",{url:this.formActionUrl,entryId:this.entryIdField,email:s});try{new URL(this.formActionUrl)}catch{return console.error("Invalid form URL:",this.formActionUrl),!1}const a=await fetch(this.formActionUrl,{method:"POST",mode:"no-cors",body:r,headers:{"Content-Type":"application/x-www-form-urlencoded"}});return console.log("Form submission response:",{status:a.status,type:a.type,ok:a.ok}),!0}catch(r){return console.error("Form submission failed:",{error:r.message,stack:r.stack}),!1}}async testSubmission(s="test@example.com"){if(console.log("Starting test submission..."),!this.enabled)return console.error("Test failed: Integration not enabled"),!1;try{console.log("Creating test form data...");const r=new FormData;r.append(this.entryIdField,s),console.log("Test submission data:",{url:this.formActionUrl,entryId:this.entryIdField,email:s});const a=await fetch(this.formActionUrl,{method:"POST",mode:"no-cors",body:r,headers:{"Content-Type":"application/x-www-form-urlencoded"}});return console.log("Test submission response:",{status:a.status,type:a.type,ok:a.ok}),!0}catch(r){return console.error("Test submission failed:",{error:r.message,stack:r.stack}),!1}}}const U=new Se;console.log("GoogleFormSubmitter instance exported");document.addEventListener("DOMContentLoaded",()=>{const x=new be,s="https://docs.google.com/forms/d/1btlD5vYAe1dB6NKE3d5SDKykLNTmakQdZN4-fQ98ITo/formResponse",r="entry.254925734";console.log("Initializing Google Form integration with:",{url:s,entryId:r});const a=U.init(s,r);console.log("Google Form initialization result:",a),U.testSubmission("test@morningpages.app").then(e=>{console.log("Google Form test submission result:",e)}).catch(e=>{console.error("Google Form test submission error:",e)});const l=document.querySelectorAll(".collapsible");l.forEach(e=>{const t=e.nextElementSibling;e===l[0]&&(e.classList.add("active"),t.classList.add("active")),e.addEventListener("click",function(){this.classList.toggle("active"),this.nextElementSibling.classList.toggle("active")})});const c=document.querySelector(".sidebar-section:nth-last-child(2)");c&&(c.style.marginBottom="2rem"),document.addEventListener("mousedown",e=>{e.button===0&&u(e.clientX,e.clientY)}),document.addEventListener("contextmenu",e=>{e.preventDefault(),m(e.clientX,e.clientY)});function u(e,t){const o=document.createElement("div");o.className="chocobo-feather",o.style.left=`${e}px`,o.style.top=`${t}px`;const i=Math.random()*Math.PI*2,n=50+Math.random()*50,y=Math.cos(i)*n,p=Math.sin(i)*n;o.style.setProperty("--tx",`${y}px`),o.style.setProperty("--ty",`${p}px`),document.body.appendChild(o),setTimeout(()=>o.remove(),1e3)}function m(e,t){const o=document.createElement("div");o.className="moogle-popup",o.style.setProperty("--x",`${e-20}px`),o.style.setProperty("--y",`${t-20}px`),document.body.appendChild(o),setTimeout(()=>o.remove(),2e3)}const d=document.getElementById("text-editor"),f=document.getElementById("word-count"),L=document.getElementById("progress-bar-fill");document.getElementById("analysis-section");const I=document.getElementById("celebration-container"),P=document.getElementById("login-form"),G=document.getElementById("login-container"),D=document.getElementById("app-content"),_=document.querySelector(".sidebar-toggle"),Y=document.querySelector(".sidebar"),J=document.querySelector(".main-content");let R=750,j=null,T=[],K=!1,v=null,w=[],z=new Set;_.addEventListener("click",()=>{Y.classList.toggle("open"),J.classList.toggle("sidebar-open")}),P.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("email").value,o=document.getElementById("password").value;try{console.log("Attempting login for:",t);const i=await x.getUser(t);if(console.log("User check result:",i?"Found":"Not found"),i){if(await x.hashPassword(o)!==i.password)throw new Error("Invalid password");console.log("Password verified successfully")}else{console.log("Creating new user"),await x.createUser(t,o),console.log("Submitting new user email to Google Form:",t);const n=await U.submitEmail(t);console.log("Google Form submission result:",n),console.log("New user created successfully")}await x.updateUserLastLogin(t),console.log("Last login updated"),v=t,console.log("Current user set to:",v),console.log("Starting transition to main app..."),G.classList.add("hidden"),setTimeout(async()=>{try{console.log("Initializing app state..."),D.style.display="block",D.offsetWidth,D.classList.add("visible"),await me();const n=await x.getTodayWriting();n&&(console.log("Loading today's writing..."),d.value=n.text,A(n.wordCount)),j=Date.now(),d.addEventListener("input",Z),d.addEventListener("keydown",X),O(V(d.value)),N(H(d.value)),M(),q(),console.log("Login successful, app initialized")}catch(n){console.error("Error during app initialization:",n);const y=document.createElement("div");y.className="error-message",y.textContent=n.message,P.appendChild(y),setTimeout(()=>y.remove(),3e3),G.classList.remove("hidden"),D.style.display="none",D.classList.remove("visible")}},300)}catch(i){console.error("Login error:",i);const n=document.createElement("div");n.className="error-message",n.textContent=i.message==="Invalid password"?"Invalid password. Please try again.":"Failed to load your data. Please try again.",P.appendChild(n),setTimeout(()=>n.remove(),3e3)}});function Z(){const e=d.value,t=ee(e);A(t),te(t),W(e),oe(),re(e)}function X(e){if(e.key==="Tab"){e.preventDefault();const t=d.selectionStart,o=d.selectionEnd;d.value=d.value.substring(0,t)+"    "+d.value.substring(o),d.selectionStart=d.selectionEnd=t+4}}function ee(e){return e.trim().split(/\s+/).filter(t=>t.length>0).length}const A=he(function(){const e=d.value,t=$(e);f.textContent=`${t} words`;const o=t/R*100;L.style.width=`${Math.min(o,100)}%`,t>=R&&!K&&(K=!0,le())},100);function te(e){j||(j=Date.now());const t=(Date.now()-j)/1e3/60;T.push({count:e,time:t}),w.push({time:t,speed:e/t})}function W(e){const t=V(e),o=H(e);O(t),N(o),M(),q()}function V(e){const t={joy:0,sadness:0,anger:0,fear:0,surprise:0},o={joy:["happy","excited","wonderful","great","amazing","love","loved","loving"],sadness:["sad","depressed","unhappy","miserable","lonely","hurt"],anger:["angry","mad","furious","hate","hated","hateful","annoyed"],fear:["afraid","scared","fear","fearful","anxious","worried"],surprise:["surprised","shocked","amazed","astonished","wow"]};return e.toLowerCase().split(/\s+/).forEach(n=>{for(const[y,p]of Object.entries(o))p.includes(n)&&t[y]++}),t}function H(e){const t={work:0,relationships:0,health:0,creativity:0,dreams:0},o={work:["work","job","career","business","project","meeting"],relationships:["friend","family","partner","relationship","love"],health:["health","exercise","diet","sleep","energy","tired"],creativity:["creative","art","write","draw","paint","music"],dreams:["dream","goal","future","plan","hope","wish"]};return e.toLowerCase().split(/\s+/).forEach(n=>{for(const[y,p]of Object.entries(o))p.includes(n)&&t[y]++}),t}function oe(){if(w.length>0){const e=w[w.length-1].speed;document.getElementById("avg-pace").textContent=`⚡ ${Math.round(e)} wpm`}}function re(e){const t=e.toLowerCase().split(/\s+/),o=new Map;t.forEach(i=>{i.length>3&&o.set(i,(o.get(i)||0)+1)}),z=Array.from(o.entries()).sort((i,n)=>n[1]-i[1]).map(([i,n])=>({word:i,frequency:n}))}function Q(e,t=1){return{joy:`rgba(255, 215, 0, ${t})`,sadness:`rgba(100, 149, 237, ${t})`,anger:`rgba(255, 99, 71, ${t})`,fear:`rgba(147, 112, 219, ${t})`,surprise:`rgba(32, 178, 170, ${t})`}[e]||`rgba(52, 152, 219, ${t})`}function O(e){const t=Object.values(e).reduce((i,n)=>i+n,0),o=Object.entries(e).map(([i,n])=>({emotion:i,count:n,percentage:t>0?n/t*100:0}));ne(o,"emotions-chart")}function N(e){const t=Object.values(e).reduce((i,n)=>i+n,0),o=Object.entries(e).map(([i,n])=>({topic:i,count:n,percentage:t>0?n/t*100:0}));ae(o,"topics-chart")}function M(){if(w.length<2)return;const e=w.map(t=>({time:t.time,wordsPerMinute:t.speed}));se(e,"speed-graph")}function se(e,t){const i=document.getElementById(t).getContext("2d"),n=getComputedStyle(document.documentElement).getPropertyValue("--accent-color").trim(),y=getComputedStyle(document.documentElement).getPropertyValue("--text-primary").trim(),p=getComputedStyle(document.documentElement).getPropertyValue("--text-secondary").trim();window.speedChart&&window.speedChart.destroy();const E=e.map(C=>`${Math.round(C.time)}m`),k=e.map(C=>C.wordsPerMinute);window.speedChart=new Chart(i,{type:"line",data:{labels:E,datasets:[{label:"Words Per Minute",data:k,borderColor:n,backgroundColor:"rgba(0, 255, 157, 0.1)",borderWidth:2,pointRadius:4,pointBackgroundColor:n,tension:.4,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:"Writing Speed Over Time",font:{size:16,color:y}},tooltip:{callbacks:{label:function(C){return`${C.parsed.y} words/min`}}},legend:{display:!1}},scales:{x:{title:{display:!0,text:"Time Elapsed (minutes)",font:{size:12,color:p}},grid:{display:!1}},y:{title:{display:!0,text:"Words Per Minute",font:{size:12,color:p}},beginAtZero:!0,suggestedMax:40,grid:{color:"rgba(255, 255, 255, 0.05)"}}},animation:{duration:1e3}}})}function ne(e,t){const i=document.getElementById(t).getContext("2d"),n=getComputedStyle(document.documentElement).getPropertyValue("--text-primary").trim(),y=getComputedStyle(document.documentElement).getPropertyValue("--text-secondary").trim();window.emotionsChart&&window.emotionsChart.destroy();const p=e.sort((h,F)=>F.percentage-h.percentage),E=p.map(h=>h.emotion),k=p.map(h=>h.percentage),C=p.map(h=>Q(h.emotion,.7)),g=p.map(h=>Q(h.emotion,1));window.emotionsChart=new Chart(i,{type:"bar",data:{labels:E,datasets:[{label:"Emotional Tone",data:k,backgroundColor:C,borderColor:g,borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",plugins:{title:{display:!0,text:"Emotional Tone Analysis",font:{size:16,color:n}},tooltip:{callbacks:{label:function(h){return`${h.parsed.x}%`}}},legend:{display:!1}},scales:{x:{beginAtZero:!0,max:100,title:{display:!0,text:"Percentage (%)",font:{size:12,color:y}}},y:{grid:{display:!1}}},animation:{duration:500}}})}function ae(e,t){const i=document.getElementById(t).getContext("2d"),n=getComputedStyle(document.documentElement).getPropertyValue("--accent-color").trim(),y=getComputedStyle(document.documentElement).getPropertyValue("--accent-color-2").trim(),p=getComputedStyle(document.documentElement).getPropertyValue("--accent-color-3").trim(),E=getComputedStyle(document.documentElement).getPropertyValue("--accent-color-4").trim(),k=getComputedStyle(document.documentElement).getPropertyValue("--accent-color-5").trim(),C=getComputedStyle(document.documentElement).getPropertyValue("--text-primary").trim(),g=getComputedStyle(document.documentElement).getPropertyValue("--text-secondary").trim();window.topicsChart&&window.topicsChart.destroy();const h=e.sort((S,fe)=>fe.percentage-S.percentage),F=h.map(S=>S.topic),b=h.map(S=>S.percentage);window.topicsChart=new Chart(i,{type:"doughnut",data:{labels:F,datasets:[{data:b,backgroundColor:[n,y,p,E,k],borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:"Topic Distribution",font:{size:16,color:C}},tooltip:{callbacks:{label:function(S){return`${S.label}: ${S.parsed}%`}}},legend:{position:"right",labels:{boxWidth:12,padding:10,font:{size:11,color:g}}}},animation:{animateRotate:!0,animateScale:!0}}})}const ie=["the","and","that","have","for","not","with","you","this","but","his","from","they","she","her","will","what","all","would","there","their","when","who","make","can","like","time","just","him","know","take","into","year","your","good"];function ce(e,t){d3.select(t).html("");const o=e.toLowerCase().replace(/[^\w\s]/g,"").split(/\s+/).filter(g=>g.length>3&&!ie.includes(g)),i={};o.forEach(g=>{i[g]=(i[g]||0)+1});const n=Object.entries(i).map(([g,h])=>({text:g,size:h})).filter(g=>g.size>1).sort((g,h)=>h.size-g.size).slice(0,50),y=d3.scaleLog().domain([Math.min(...n.map(g=>g.size)),Math.max(...n.map(g=>g.size))]).range([10,60]),p=d3.select(t).node().getBoundingClientRect().width,E=300;d3.layout.cloud().size([p,E]).words(n).padding(5).rotate(()=>0).fontSize(g=>y(g.size)).spiral("archimedean").on("end",C).start();function C(g){const F=d3.select(t).append("svg").attr("width",p).attr("height",E).attr("class","word-cloud").append("g").attr("transform",`translate(${p/2},${E/2})`).selectAll("text").data(g).enter().append("text").style("font-size",b=>`${b.size}px`).style("fill",(b,S)=>d3.schemeCategory10[S%10]).attr("text-anchor","middle").attr("transform",b=>`translate(${b.x},${b.y})`).attr("class","word-cloud-word").style("opacity",0).text(b=>b.text);F.transition().duration(500).delay((b,S)=>S*20).style("opacity",1),F.append("title").text(b=>`${b.text}: ${b.size} occurrences`)}}function q(){const e=document.getElementById("keyword-cloud");if(e.innerHTML="",!d.value.trim()){e.innerHTML='<div class="keyword-tag">Start writing to see your most used words</div>';return}B(o=>{ce(o,e)},500)(d.value)}function le(){I.classList.add("show"),de(),setTimeout(()=>{I.classList.remove("show")},5e3)}function de(){for(let e=0;e<50;e++){const t=document.createElement("div");t.className="confetti",t.style.left=`${Math.random()*100}%`,t.style.animationDelay=`${Math.random()*3}s`,I.appendChild(t)}}async function ue(){if(v)try{const e={wordHistory:T,writingSpeedData:w,keywords:Array.from(z),emotions:window.emotionsChart?window.emotionsChart.data:null,topics:window.topicsChart?window.topicsChart.data:null};await x.saveWriting(d.value,e)}catch(e){console.error("Failed to save progress:",e),localStorage.setItem(`morning-pages-${v}`,JSON.stringify({text:d.value,wordCount:$(d.value),timestamp:Date.now(),wordHistory:T,writingSpeedData:w,keywords:Array.from(z)}))}}async function ge(){if(!v){console.log("No current user, skipping progress load");return}try{console.log("Loading progress for user:",v);const e=await x.getTodayWriting();if(e){console.log("Found today's writing, updating editor..."),d.value=e.text,T=e.wordHistory||[],w=e.writingSpeedData||[],z=new Set(e.keywords||[]);const t=e.wordCount||$(e.text);if(A(t),e.emotions&&O(e.emotions),e.topics&&N(e.topics),w.length>0){const o=w[w.length-1].speed;document.getElementById("avg-pace").textContent=`⚡ ${Math.round(o)} wpm`}e.text.trim()&&W(e.text)}else console.log("No writing found for today")}catch(e){console.error("Failed to load progress:",e);try{const t=localStorage.getItem(`morning-pages-${v}`);if(t){console.log("Found progress in localStorage, restoring...");const o=JSON.parse(t);d.value=o.text,T=o.wordHistory||[],w=o.writingSpeedData||[],z=new Set(o.keywords||[]),A(o.wordCount),W(o.text)}else console.log("No saved progress found in localStorage")}catch(t){throw console.error("Failed to load from localStorage:",t),new Error("Failed to load your saved data")}}}async function me(){try{if(console.log("Starting to load user data..."),!v)throw console.error("No current user found"),new Error("No user logged in");console.log("Loading progress for user:",v),await ge(),console.log("Initializing UI elements..."),d.value.trim()&&(console.log("Analyzing existing text..."),W(d.value)),console.log("User data loaded successfully")}catch(e){throw console.error("Failed to load user data:",e),e}}const pe=B(async function(e){if(v)try{const t={wordHistory:T,writingSpeedData:w,keywords:Array.from(z),emotions:window.emotionsChart?window.emotionsChart.data:null,topics:window.topicsChart?window.topicsChart.data:null};await x.saveWriting(e,t)}catch(t){console.error("Failed to autosave:",t),localStorage.setItem(`morning-pages-${v}`,JSON.stringify({text:e,wordCount:$(e),timestamp:Date.now(),wordHistory:T,writingSpeedData:w,keywords:Array.from(z)}))}},1e3);setInterval(ue,3e4);function he(e,t){let o;return function(){const i=arguments,n=this;o||(e.apply(n,i),o=!0,setTimeout(()=>o=!1,t))}}function B(e,t){let o;return function(...i){clearTimeout(o),o=setTimeout(()=>e.apply(this,i),t)}}class ye{constructor(){this.worker=null,this.isAnalyzing=!1,this.queue=[],this.initWorker(),this.emotionKeywords={happy:["happy","joy","excited","glad","pleased","delight","smile","laugh"],sad:["sad","unhappy","depressed","miserable","sorrow","cry","tears"],angry:["angry","mad","furious","rage","upset","annoyed","irritated"],anxious:["anxious","worry","nervous","stress","tense","afraid","fear"],calm:["calm","peaceful","relaxed","tranquil","serene","quiet"],grateful:["grateful","thankful","appreciate","thanks","blessed"]},this.topicKeywords={work:["work","job","office","project","boss","career","meeting"],family:["family","mom","dad","parent","child","son","daughter","wife","husband"],health:["health","exercise","workout","gym","diet","eat","food","sleep"],creative:["write","create","idea","design","art","music","book","story"],future:["future","plan","goal","dream","hope","wish"]}}initWorker(){window.Worker&&(this.worker=new Worker("text-analysis-worker.js"),this.worker.onmessage=t=>{const{emotions:o,topics:i}=t.data,n=this.queue.shift();n&&n(o,i),this.isAnalyzing=!1,this.processQueue()})}analyzeText(t,o){this.queue.push(o),this.isAnalyzing||this.processQueue()}processQueue(){this.queue.length===0||this.isAnalyzing||(this.isAnalyzing=!0,this.worker.postMessage({text,emotionKeywords:this.emotionKeywords,topicKeywords:this.topicKeywords}))}}const we=new ye;function $(e){const t=e.trim().match(/\S+/g);return t?t.length:0}d.addEventListener("input",function(){const e=this.value;A(),pe(e),we.analyzeText(e,(t,o)=>{O(t),N(o),M(),q()})})});
